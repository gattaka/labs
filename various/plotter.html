<html>
<body>
<div>
<canvas id="can" width="500" height="300" style="cursor: pointer"></canvas>
</div>
<script>let $ = {};
$.plotter = (function() {
	
	let canvas = document.getElementById("can");
	let ctx = canvas.getContext("2d");
	let width = canvas.width;
	let height = canvas.height;	
	let dragged = false;
	let draggedStartX;
	let draggedStartY;
	
	let startX = -5;
	let endX = 10.1;
	
	let startY = 20.6;
	let endY = -5;
	
	// na kolik procent je protažená Y osa?
	let xUnitProjection = 1.01;		
	let yUnitProjection = 1.01;
			
	let xLength;
	let yLength;
	let cyUnit;
	let cxUnit;
	
	let calibrate = function() {
		xLength = Math.abs(startX - endX) * xUnitProjection;
		yLength = Math.abs(startY - endY) * yUnitProjection;			
		cyUnit = height / yLength;
		cxUnit = width / xLength;
	};
	
	let func = function(x) {
		return x * x;
	};

	let ensureAxisUnitDigits = function(num, unit) {
		let unitStr = unit.toString();
		let numStr = num.toString();
		if (num > 0 && numStr.length > unitStr.length + 1)
			return Number(numStr.substring(0, unitStr.length));
		if (num < 0 && numStr.length > unitStr.length + 2)
			return Number(numStr.substring(0, unitStr.length + 1));
		return num;
	};

	let roundAxisUnit = function(unit) {
		if (unit == 1)
			return 1;
		let str = unit.toString();	
		let dotIndex = str.indexOf(".");
		if (dotIndex > -1) {
			if (str.startsWith("0")) {
				let index = 0;
				for (let i = str.indexOf(".") + 1; i < str.length; i++) {
					if (str.charAt(i) != "0") {
						index = i;
						break;
					}
				}
				let prefix = str.substring(0, index + 1);	
				let prefixLastDigit = prefix.substring(prefix.length - 1, prefix.length);		
				switch (prefixLastDigit) {
					case "0":
					case "2":
					case "5":
						return Number(prefix);
					case "9":
					case "8":
					case "7":
					case "6":
						return Number(prefix.substring(0, prefix.length - 1) + "5");
					case "4":
					case "3":
						return Number(prefix.substring(0, prefix.length - 1) + "2");
					case "1":				
						return Number(prefix);			
				}
			} else {
				str = str.substring(0, dotIndex);
				if (str == "1")
					return 1;
			}			
		}			
		let lastDigit = str.substring(str.length - 1, str.length);
		switch (lastDigit) {
			case "0":
			case "2":
			case "5":
				return Number(str);
			case "9":
			case "8":
			case "7":
			case "6":
				return Number(str.substring(0, str.length - 1) + "5");
			case "4":
			case "3":
				return Number(str.substring(0, str.length - 1) + "2");
			case "1":				
				return Number(str.substring(0, str.length - 1) + "0");			
		}		
	};

	let paint = function() {		
		ctx.clearRect(0, 0, width, height);
		ctx.strokeStyle = "grey";
		ctx.fillStyle = "grey";
		let fontSize = 13;
		let fontOffset = 8;
		let axesDrawTolerance = fontSize + fontOffset;
		ctx.font = fontSize + "px Monospace";		
		
		ctx.strokeRect(0, 0, width, height);

		let pointSize = 3;

		calibrate();

		let fromX = Math.min(startX, endX);
		let toX = Math.max(startX, endX);
		let stepX = xLength / width;		
		if (stepX <= 0 || fromX > toX) {
			console.log("Plotter error, infinite cycle detected!");
			return;
		}
		
		let fromY = Math.min(startY, endY);
		let toY = Math.max(startY, endY);
		
		// poloha hlavních osy 
		let cyZero = height + Math.min(startY, endY) * cyUnit;
		let cxZero = - Math.min(startX, endX) * cxUnit;
		
		// X OSA
		
		// x sekundární osa grafu		
		let secXAxisCount = 8;	
		let secXAxisUnit = yLength / secXAxisCount;			
		let secXAxisRoundedUnit = roundAxisUnit(secXAxisUnit);
		secXAxisCount = Math.ceil(yLength / secXAxisRoundedUnit);
		if (secXAxisCount < 1 || secXAxisCount == Infinity)
			secXAxisCount = 1;
		let secXAxisOffset = Math.floor(fromY / secXAxisRoundedUnit) * secXAxisRoundedUnit;
		
		ctx.setLineDash([5, 5]);
		ctx.strokeStyle = "lightgrey";
		ctx.fillStyle = "grey";
		ctx.textAlign = "left";
		for (let i = 0; i <= secXAxisCount; i++) {		
			let axisNumber = secXAxisRoundedUnit * i + secXAxisOffset;
			let cy = cyZero - axisNumber * cyUnit;
			// kontrolu, zda nebude osa a text už moc nahoře (a byl by tedy ořízlý)
			if (cy < -axesDrawTolerance || cy > height + axesDrawTolerance)
				continue;			
	
			ctx.beginPath();
			ctx.moveTo(0, cy);
			ctx.lineTo(width, cy);
			ctx.stroke();

			let textY = cy - fontOffset;					
			ctx.fillText(ensureAxisUnitDigits(axisNumber, secXAxisRoundedUnit), cxZero + fontOffset, textY);				
		}
				
		// x osa grafu		
		ctx.setLineDash([]);
		ctx.strokeStyle = "grey";
		ctx.fillStyle = "grey";
		ctx.beginPath();
		ctx.moveTo(0, cyZero);
		ctx.lineTo(width, cyZero);
		ctx.stroke();
				
		// Y OSA
				
		// y sekundární osa grafu		
		let secYAxisCount = 8;	
		let secYAxisUnit = xLength / secYAxisCount;				
		let secYAxisRoundedUnit = roundAxisUnit(secYAxisUnit);		
		secYAxisCount = Math.ceil(xLength / secYAxisRoundedUnit);
		if (secYAxisCount < 1 || secYAxisCount == Infinity)
			secYAxisCount = 1;
		let secYAxisOffset = Math.floor(fromX / secYAxisRoundedUnit) * secYAxisRoundedUnit;
		
		ctx.setLineDash([5, 5]);
		ctx.strokeStyle = "lightgrey";
		ctx.fillStyle = "grey";
		for (let i = 0; i <= secYAxisCount; i++) {	
			let axisNumber = secYAxisRoundedUnit * i + secYAxisOffset;
			let cx = cxZero + axisNumber * cxUnit;			
			if (cx < -axesDrawTolerance || cx > width + axesDrawTolerance)
				continue;
		
			let textX = cx + fontOffset;

			ctx.beginPath();
			ctx.moveTo(cx, 0);
			ctx.lineTo(cx, height);
			ctx.stroke();		
			ctx.textAlign = "left";
			ctx.fillText(ensureAxisUnitDigits(axisNumber, secYAxisRoundedUnit), textX, cyZero - fontOffset);	
		}
					
		// y osa grafu		
		ctx.setLineDash([]);
		ctx.strokeStyle = "grey";
		ctx.fillStyle = "grey";
		ctx.beginPath();
		ctx.moveTo(cxZero, 0);
		ctx.lineTo(cxZero, height);
		ctx.stroke();

		// PLOT

		for (let x = fromX; x <= toX; x += stepX) {
			let cx = x * cxUnit + cxZero;
			let cy = cyZero - func(x) * cyUnit;
			ctx.fillStyle = "blue";
			ctx.fillRect(cx - pointSize / 2, cy - pointSize / 2, pointSize, pointSize);
		}
	};

	canvas.addEventListener("wheel", function(e) {
		let multiplier = 1.1;
		let delta = e.deltaY > 0 ? multiplier : 1 / multiplier;		
		startX *= delta;
		endX *= delta;
		startY *= delta;
		endY *= delta;
		paint();
	});	
		
	canvas.addEventListener("mousedown", function (e) {
		dragged = true;
		draggedStartX = e.clientX;
		draggedStartY = e.clientY;
	}, false);
 
	canvas.addEventListener("mouseup", function (e) {
		dragged = false;
	}, false);
	
	canvas.addEventListener("mouseleave", function (e) {
		dragged = false;
	}, false);
	
	canvas.addEventListener("mousemove", function (e) {
		if (!dragged) 
			return;
		let difX = (draggedStartX - e.clientX) / cxUnit;
		let difY = (draggedStartY - e.clientY) / cyUnit;
		startX += difX;
		endX += difX;
		startY -= difY;
		endY -= difY;
		paint();
		draggedStartX = e.clientX;
		draggedStartY = e.clientY;		
	}, false);

	return {
		start: function() {
			paint();
		},
		
		round: function(x) {
			return roundAxisUnit(x);
		}
	};
	
})();

$.plotter.start();
</script>
</body>
</html>