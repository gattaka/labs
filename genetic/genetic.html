<table>
	<tbody>
		<tr>
			<td>Items <10-100></td>
			<td>Max weight <1-100></td>
			<td>Max price <1-100></td>
			<td>Backpack max weight <10-1000></td>
			<td></td>
		</tr>
		<tr>
			<td><input id="itemsInput" style="width: 100px;" value="10"/></td>
			<td><input id="maxWeightInput" style="width: 110px;" value="10"/></td>
			<td><input id="maxPriceInput" style="width: 110px;" value="30"/></td>		
			<td><input id="backpackWeightInput" style="width: 180px;" value="30"/></td>
			<td><button type="button" onclick="$.genetics.seed()">Generate!</button></td>
		</tr>
	</tbody>
</table>
Seed <weight, price><br/>
<textarea id="seed" style="width: 706px;" rows="5"></textarea>
<table>
	<tbody>
		<tr>
			<td>Generations <10-1000></td>
			<td>Creatures <100-1000></td>
			<td>Elite <1-Creatures/2></td>
			<td>Idiots <1-Creatures/2></td>
			<td>Mutations <1-20></td>
			<td></td>
		</tr>
		<tr>
			<td><input id="generationsInput" style="width: 130px;" value="10"/></td>
			<td><input id="creaturesInput" style="width: 130px;" value="100"/></td>
			<td><input id="eliteInput" style="width: 120px;" value="5"/></td>
			<td><input id="idiotsInput" style="width: 120px;" value="1"/></td>
			<td><input id="mutationsInput" style="width: 100px;" value="1"/></td>
			<td></td>
		</tr>
		<tr>
			<td>Delay (ms) <1-1000></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
		</tr>
		<tr>
			<td><input id="delayInput" style="width: 120px;" value="30"/></td>
			<td><button type="button" onclick="$.genetics.start()">Run!</button></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
		</tr>
	</tbody>
</table><table>
	<tbody>
		<tr>
			<td># Generation</td>
			<td>Best price</td>
			<td>Creature</td>
		</tr>
		<tr>
			<td><input id="resultGeneration" style="width: 120px; 
				background-color: #faf7eb; border: 1px solid #a8a8a8;" readonly/></td>
			<td><input id="resultPrice" style="width: 120px; 
				background-color: #faf7eb; border: 1px solid #a8a8a8;" readonly/></td>
			<td><input id="resultConfiguration" style="width: 448px; 
				background-color: #faf7eb; border: 1px solid #a8a8a8;" readonly/></td>
		</tr>
		<tr>
			<td><input id="resultGenerationAll" style="width: 120px; 
				background-color: #faf7eb; border: 1px solid #a8a8a8;" readonly/></td>
			<td><input id="resultPriceAll" style="width: 120px; 
				background-color: #faf7eb; border: 1px solid #a8a8a8;" readonly/></td>
			<td><input id="resultConfigurationAll" style="width: 448px;
				background-color: #faf7eb; border: 1px solid #a8a8a8;" readonly/></td>
		</tr>
	</tbody>
</table>
<div style="margin-top: 10px;"><canvas id="myCanvas" width="714" height="600"></canvas></div>
<script>
let $ = {};
$.genetics = (function() {
	/**
	 * https://stackoverflow.com/questions/2353211/hsl-to-rgb-color-conversion
	 * https://stackoverflow.com/questions/17433015/change-the-hue-of-a-rgb-color-in-javascript
	 * Converts an HSL color value to RGB. Conversion formula
	 * adapted from http://en.wikipedia.org/wiki/HSL_color_space.
	 * Assumes h, s, and l are contained in the set [0, 1] and
	 * returns r, g, and b in the set [0, 255].
	 *
	 * @param   {number}  h       The hue
	 * @param   {number}  s       The saturation
	 * @param   {number}  l       The lightness
	 * @return  {Array}           The RGB representation
	 */
	let hslToRGB = function(h, s, l) {
	    let r, g, b;

	    if (s == 0) {
	        r = g = b = l; // achromatic
	    } else {
	        let hue2rgb = function hue2rgb(p, q, t){
	            if(t < 0) t += 1;
	            if(t > 1) t -= 1;
	            if(t < 1/6) return p + (q - p) * 6 * t;
	            if(t < 1/2) return q;
	            if(t < 2/3) return p + (q - p) * (2/3 - t) * 6;
	            return p;
	        }

	        let q = l < 0.5 ? l * (1 + s) : l + s - l * s;
	        let p = 2 * l - q;
	        r = hue2rgb(p, q, h + 1/3);
	        g = hue2rgb(p, q, h);
	        b = hue2rgb(p, q, h - 1/3);
	    }

	    return "#" + ((1 << 24) + (Math.round(r * 255) << 16) + ( Math.round(g * 255) << 8) + Math.round(b * 255)).toString(16).slice(1);
	};

	// konfigurace
	let generations;
	let creaturesCount;
	let backpackWeight;
	let delay;
	
	let creatures;
	let items;
		
	let fullMask;
	let lowerHalfMask;
	let higherHalfMask;
	
	let eliteCount;
	let idiotsCount;
	let mutationsCount;

	let bestGeneration;
	let bestCreature;
	
	let canvas = document.getElementById("myCanvas");
	let ctx = canvas.getContext("2d");

	let width = canvas.width;
	let height = canvas.height;

	let innerIntervalCallback;
	
	let printBinary = function(creature) {
		let result = "";
		let mask = 1;
		for (let i = 0; i < items.length; i++) {
			result = (((creature & mask) > 0) ? 1 : 0) + result;		
			mask = mask << 1;
		}
		return result;
	};

	let fitness = function(creature) {
		let w = 0;
		let p = 0;
		let mask = 1;
		for (let i = 0; i < items.length; i++) {
			// nemá cenu dál maskovat, pokud už creature 
			// nemá další vyšší 1, než má maska
			if (mask > creature)
				return p;
			if ((creature & mask) > 0) {				
				w += items[i][0];
				if (w > backpackWeight) 
					return -1;
				p += items[i][1];
			}
			mask = mask << 1;
		}
		return p;
	};

	let fight = function(creatureA, creatureB) {
		let fa = fitness(creatureA);
		let fb = fitness(creatureB);
		if (fa > fb)
			return -1;
		if (fa < fb)
			return 1;
		return 0;
	};

	let initPopulation = function() {
		// rovnoměrně roprostřít
		let max = 1 << items.length;
		let step = max / creaturesCount;
		creatures = [];
		for (let c = 0; c < max; c += step)
			creatures[creatures.length] = Math.floor(c);		
	};

	let paintCreatures = function() {	
		let canvasArea = width * height;
		let areaMultiplier = creatures.length;
		let heightCreature = Math.floor(Math.sqrt(height * height / areaMultiplier)); 
		let widthCreature = Math.floor(heightCreature * width / height);
		let creaturesPerRow = Math.floor(width / widthCreature);

		// měřítkem pro barvu je fitness nejlepšího jedince
		let step = 1 / fitness(creatures[0]);

		let row = 0;
		for (let c = 0; c < creatures.length; c++) {
			let koef = fitness(creatures[c]);
			if (koef == -1) 
				koef = 0;
			let fillColor = hslToRGB(
				0.12,
				step * koef,
				0.5
			);
			let strokeColor = hslToRGB(
				0.12,
				step * koef,
				0.6
			);
			ctx.fillStyle = fillColor;
			ctx.strokeStyle = strokeColor;
			let x = (c % creaturesPerRow) * widthCreature;
			let y = Math.floor(c / creaturesPerRow) * heightCreature;
			ctx.fillRect(x, y, widthCreature, heightCreature);
			ctx.strokeRect(x, y, widthCreature, heightCreature);
		}
	};

	let mate = function(creatureA, creatureB) {		
		return (creatureA & higherHalfMask) + (creatureB & lowerHalfMask);	
	};

	let mutate = function(creature) {		
		let index = Math.floor(Math.random() * items.length);
		let mask = 1 << index;
		creature += (creature & mask > 0) ? - mask : mask;
		return creature;
	};

	let createNewGeneration = function(parents) {
		let newCreatures = [];
		while (true) {
			for (let a = 0; a < parents.length; a++) {
				for (let b = 0; b < parents.length; b++) {
					let newCreature = mate(parents[a], parents[b]);
					for (let c = 0; c < mutationsCount; c++)
						newCreature = mutate(newCreature);
					newCreatures[newCreatures.length] = newCreature;
					if (newCreatures.length == creatures.length)
						return newCreatures;
				}
			}				
		}
	};

	let runGeneration = function(generation) {
		if (generation < generations) {
			// seřadit
			creatures.sort(fight);

			document.getElementById("resultGeneration").value = generation + 1;
			document.getElementById("resultPrice").value = fitness(creatures[0]);
			document.getElementById("resultConfiguration").value = printBinary(creatures[0]);

			if (bestGeneration == -1 || fitness(creatures[0]) >= fitness(bestCreature)) {
				bestCreature = creatures[0];
				bestGeneration = generation + 1;
				document.getElementById("resultGenerationAll").value = bestGeneration;
				document.getElementById("resultPriceAll").value = fitness(bestCreature);
				document.getElementById("resultConfigurationAll").value = printBinary(bestCreature);
			}

			// vykreslit
			paintCreatures();
			
			// namnožit novou generaci
			let parents = [];
			// elity
			for (let c = 0; c < eliteCount; c++) 
				parents[parents.length] = creatures[c];			
			// idioti
			for (let c = 0; c < idiotsCount; c++)
				parents[parents.length] = creatures[creatures.length - 1 - c];			
			creatures = createNewGeneration(parents);

			setTimeout(function() {
				runGeneration(generation + 1);
			}, delay);
		} else {
			// TODO
			return;	
		} 
	};

	let run = function() {
		ctx.clearRect(0, 0, width, height);
		initPopulation();
		runGeneration(0);
	};	

	let validate = function(msg, field, min, max) {
		let value = document.getElementById(field).value;
		if (isNaN(value)) {
			alert(msg);
			return false;
		}
		value = Number(value);
		if (value < min || value > max) {
			alert(msg);
			return false;
		}
		return value;
	};

	return {
		start: function() {
			let generationsParam = validate("Invalid generations", "generationsInput", 10, 1000);
			let creaturesParam = validate("Invalid creatures", "creaturesInput", 100, 1000);		
			let eliteParam = validate("Invalid elite", 
				"eliteInput", 1, Math.floor(creaturesParam / 2));			
			let idiotsParam = validate("Invalid idiots", 
				"idiotsInput", 1, Math.floor(creaturesParam / 2));		
			let mutationsParam = validate("Invalid mutations", "mutationsInput", 1, 20);	
			let maxBackpackWeightParam = validate(
				"Invalid backpack max weight", "backpackWeightInput", 10, 1000);

			let delayParam = validate("Invalid delay", "delayInput", 1, 50);

			if (generationsParam && creaturesParam && maxBackpackWeightParam && delayParam
				&& eliteParam && idiotsParam && mutationsParam) {

				generations = generationsParam;
				creaturesCount = creaturesParam;
				eliteCount = eliteParam;
				idiotsCount = idiotsParam;
				mutationsCount = mutationsParam;
				backpackWeight = maxBackpackWeightParam;
				delay = delayParam;

				bestGeneration = -1;
			
				let seedValue = document.getElementById("seed").value;
				let regex = /^([0-9]+,[0-9]+,)+[0-9]+,[0-9]+$/g;
				if (seedValue.match(regex) == null) {
					alert("Invalid seed");
					return;
				}

				let numbers = seedValue.split(",");
				items = [];
				for (let i = 0; i < numbers.length; i+=2) 
					items[items.length] = [Number(numbers[i]), Number(numbers[i+1])];				

				fullMask = (1 << items.length) - 1;
				lowerHalfMask = (1 << Math.floor(items.length / 2)) - 1;
				higherHalfMask = fullMask - lowerHalfMask;
				
				console.log("fullMask: " + printBinary(fullMask));
				console.log("lowerHalfMask: " + printBinary(lowerHalfMask));
				console.log("higherHalfMask: " + printBinary(higherHalfMask));

				run();			
			}
		},

		seed: function() {
			let itemsParam = validate("Invalid items", "itemsInput", 10, 100);
			let maxWeightParam = validate("Invalid max weigth", "maxWeightInput", 1, 100);
			let maxPriceParam = validate("Invalid max price", "maxPriceInput", 1, 100);
			let items = [];
			if (itemsParam && maxWeightParam && maxPriceParam) {
				for (let i = 0; i < itemsParam; i++) {
					let weight = Math.floor(Math.random() * Math.floor(maxWeightParam));
					let price = Math.floor(Math.random() * Math.floor(maxPriceParam));
					items[i] = [weight, price];
				}
			}
			
			document.getElementById("seed").value = items;
		},

		paint: function() {
			paintCreatures();
		}
	};
})();

$.genetics.seed();
$.genetics.start();
</script>