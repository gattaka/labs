<head>
	<script type="text/javascript" src="../libs/colors.js"></script>
</head>

[N1]Demo[/N1]
[HTML]<table>
	<tbody>
		<tr>
			<td>Vertices <3-10></td>			
			<td></td>
		</tr>
		<tr>
			<td><input id="verticesInput" style="width: 80px;" value="6"></td>			
			<td><button type="button" onclick="$.fractalPolygon.start()">Run!</button></td>
		</tr>
	</tbody>
</table>
<div><canvas id="myCanvas" width="700" height="600"></canvas></div>[/HTML]
<script>
var $ = $ || {};
$.mandel = (function() {
		
	let interval = 100;
	let pointSize = 5;
	let steps = 50;
	let hueStep = 255 / 15;
	
	let canvas = document.getElementById("myCanvas");
	let ctx = canvas.getContext("2d");
	let innerIntervalCallback;

	let width = canvas.width;
	let height = canvas.height;
	let wHalf = width / 2;
	let hHalf = height / 2;
		
	let zoomStep = .1;
	let zoom = 1;
	let xZoomPoint = 0;
	let yZoomPoint = 0;
		
	let dragged = false;
	let xDraggedStart;
	let yDraggedStart;
	let xOffsetOrig = -wHalf;
	let yOffsetOrig = -hHalf;
	let xOffset = xOffsetOrig;
	let yOffset = yOffsetOrig;
		
	let rFrom = -2; 
	let rTo = 1;
	let iFrom = 1;
	let iTo = -1;
	let xToPlane = Math.abs(rTo - rFrom) / width;
	let yToPlane = Math.abs(iTo - iFrom) / height;
	let xToPlaneOrig = xToPlane;
	let yToPlaneOrig = yToPlane;
	
	let test = function(level, z, c) {
		if (z.r * z.r - z.i * z.i > 4)
			return level;
		level++;
		if (level > steps)
			return level;			
		return test(level, {
			r: z.r * z.r - z.i * z.i + c.r, 
			i: z.r * z.i + z.i * z.r + c.i
		}, c);
	};

	let draw = function() {
		for (let y = 0; y < height; y += pointSize) {
			for (let x = 0; x < width; x += pointSize) {
				let r = (x + xOffset) * zoom * xToPlane;
				let i = (y + yOffset) * zoom * yToPlane;
				let level = test(0, {r: 0, i: 0}, {r: r, i: i});
				ctx.fillStyle = "hsl(" + Math.floor(hueStep * level) + ", 100%, 50%)";
				ctx.fillRect(x, y, pointSize, pointSize);
			}
		}
	};
	
	let innnerChangeInterval = function(value) {
		if (isNaN(value))
			return;
		let newValue = Number(value);
		if (newValue < 1)
			return;
		if (interval) 
			console.log("interval changed from '" + interval + "' to '" + newValue + "'");
		interval = newValue;
		
		if (innerIntervalCallback) 
			clearInterval(innerIntervalCallback);
		
		innerIntervalCallback = setInterval(function() {				
			draw();			
		}, interval);
	};

	let validate = function(msg, field, min, max) {
		let value = document.getElementById(field).value;
		if (isNaN(value)) {
			alert(msg);
			return false;
		}
		value = Number(value);
		if (value < min || value > max) {
			alert(msg);
			return false;
		}
		return value;
	};
	
	canvas.addEventListener("wheel", function(e) {
		e.preventDefault();		
		
		let bound = canvas.getBoundingClientRect();
		let x = e.clientX - bound.x;
		let y = e.clientY - bound.y;
		
		let oldZoom = zoom;
		zMult = 1 + Math.sign(e.deltaY) * zoomStep;
		zoom *= zMult;
				
		let dx = (oldZoom - zoom) * (x + xOffset) / zoom;
		let dy = (oldZoom - zoom) * (y + yOffset) / zoom;
				
		xOffset += dx;
		yOffset += dy;		
		draw();
	});
		
	canvas.addEventListener("mousedown", function (e) {
		dragged = true;
		xDraggedStart = e.clientX;
		yDraggedStart = e.clientY;
	}, false);
 
	canvas.addEventListener("mouseup", function (e) {
		dragged = false;
	}, false);
	
	canvas.addEventListener("mouseleave", function (e) {
		dragged = false;
	}, false);
	
	canvas.addEventListener("mousemove", function (e) {
		if (!dragged) 
			return;
		xOffset += xDraggedStart - e.clientX;
		yOffset += yDraggedStart - e.clientY;		
		
		xDraggedStart = e.clientX;
		yDraggedStart = e.clientY;		
		draw();
	}, false);
	
	canvas.addEventListener("dblclick", function (e) {
		e.preventDefault();
		xToPlane = xToPlaneOrig;
		yToPlane = yToPlaneOrig;
		xOffset = xOffsetOrig;
		yOffset = yOffsetOrig;
		zoom = 1;
		draw();
	}, false);

	return {
		start: function() {
			let verticesParam = validate("Invalid vertices", "verticesInput", 3, 10);			
			if (verticesParam) {					
				vertexCount = verticesParam;
				//innnerChangeInterval(interval);
				draw();				
			}			
		}
	};

})();

$.mandel.start();</script>