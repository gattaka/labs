<!DOCTYPE html>
<html>
	<head>
	<script type="text/javascript" src="./js/SpriteLoader.js"></script>
	<script type="text/javascript" src="./js/LevelManager.js"></script>
	<script type="text/javascript" src="./js/GFXUtils.js"></script>
	<script type="text/javascript" src="./js/Minimap.js"></script>
	<script type="text/javascript" src="./js/IsoRenderer.js"></script>	
	<script type="text/javascript" src="./js/Configuration.js"></script>		
	<script type="text/javascript" src="./js/MapSculptor.js"></script>			
	<script type="text/javascript" src="./js/PersistanceManager.js"></script>	
	<script type="text/javascript" src="./js/FPS.js"></script>		
	<script type="text/javascript" src="./js/SpritePalette.js"></script>			
	<style>
		#mapcode-div {
			display: none;
			position: absolute;
			z-index: 10;
			width: 100%;
			height: 100%;
			background-color: hsla(0, 0%, 0%, 0.61);
			padding: 10px;
			margin: 0;
			top: 0;
			left: 0;
			box-sizing: border-box;
			text-align: center;
			font-family: monospace;
			font-size: 30px;
			color: #aaa;
			font-variant: all-small-caps;
		}

		#mapcode-text {
			width: 80%;
			height: 50%;
		}
		
		#mapcode-div a {
			cursor: pointer;
		}
		
		#mapcode-div a:hover {
			color: #55f;
		}
	</style>
</head>
<body>
<div id="mapcode-div">
	<textarea id="mapcode-text"></textarea><br/>
	<a onClick="$.GIsoGame.Editor.loadMap()">Nahrát mapu dle JSON</a><br/>
	<br/>
	<input id="map-width-text" /> x <input id="map-height-text" /><br/>
	<a onClick="$.GIsoGame.Editor.newMap()">Nová mapa</a><br/>
	<br/>
	<a onClick="$.GIsoGame.Editor.closeMenu()">Zavřít</a>
</div>
<div style="margin: 10px 0;">
	<canvas id="canvasT" style="width: 100%;" height="600"></canvas>
</div>
<script>
var $ = $ || {};
$.GIsoGame = $.GIsoGame || {};
$.GIsoGame.Editor = (function() {

	let canvas = document.getElementById("canvasT");
	let ctx = canvas.getContext("2d");
	let width;
	let height;
	let halfWidth;
	let halfHeight;
	
	let levelDraftCookieName = "GIsoGameLevelDraft";
	
	let cfg = $.GIsoGame.Configuration;
	
	let fpsUI;
	let persistanceManager;
	
	let spriteLoader;
	let spritePalette;
	
	let levelReader;
	let levelBlueprint;
	let isoRenderer;
	let mapSculptor;
	
	let lastTime = 0;
	
	let viewX = 0;
	let viewY = 0;
	
	let cellW = 64;
	let cellH = 32;	
	
	// pole všech UI prvků, které reagují na mouse události
	// povinná pole: 
	// 		x, y, width, height, visible, 
	// 		consumed = onMouse(x, y, button, down, isInBounds, uiListener)
	// 		consumed = onDrag(dx, dy, isInBounds, uiListener)
	let uiListeners = [];
	
	let desktopArea = {};	
		
	let buttonFontSize = 20;
	let buttons = [];
	
	let groundsMenu = {};
	let wallsMenu = {};
	let objectsMenu = {};
	
	// Ground tiles vyplňování
	let brush = {
		size: 1,
		mode: 1, // 1 malba, -1 mazání
		groupId: 0,
		spriteId: 0,
		tileId: 0,
		lastPaintedX: -1,
		lastPaintedY: -1,
	};		
	
	let cursor = {
		lastSx: 0,
		lastSy: 0,
		sx: 0,
		sy: 0,
		mx: 0, 
		my: 0,
		vix: 0,
		viy: 0,		
	};		

	/*
	* DRAWING
	*/	
	
	let draw = function(timestamp) {
		drawScene(timestamp);
		window.requestAnimationFrame(draw);
	};	
	
	let drawItemsMenu = function(menu) {		
		ctx.fillStyle = cfg.uiBorderColor;		
		ctx.fillRect(menu.x, menu.y, menu.width, menu.height);
		
		// zmenšení aktivní plochy menu, aby se v ní dalo pracovat s položkami
		let fromX = menu.x + cfg.uiBorder;
		let toX = menu.x + menu.width - cfg.uiBorder;
		let fromY = menu.y + cfg.uiBorder;
		let toY = menu.y + menu.height - cfg.uiBorder;
		
		ctx.fillStyle = cfg.uiAreaColor;	
		ctx.fillRect(fromX, fromY, toX - fromX, toY - fromY);
		
		let slotWidth = menu.itemWidth + cfg.uiSpacing * 2;
		let itemsStartX = Math.floor(width / 2 - slotWidth / 2);
		
		ctx.fillStyle = cfg.uiBorderColor;
		ctx.fillRect(itemsStartX, fromY, slotWidth, toY - fromY);
		
		if (menu.mouseDown) {
			let diff = cursor.sx - itemsStartX;
			menu.dragOffset -= Math.floor(diff / slotWidth) * slotWidth;
			menu.mouseDown = false;
		}
		
		let choosenItemId = Math.floor(-menu.dragOffset / slotWidth);
		if (choosenItemId < 0) {
			menu.dragOffset += slotWidth * choosenItemId;
			choosenItemId = 0;			
		} else if (choosenItemId >= menu.itemsCount) {
			menu.dragOffset += slotWidth * (choosenItemId - menu.itemsCount);
			choosenItemId = menu.itemsCount - 1;
		}
		menu.chooseItemFunc(choosenItemId);
		
		for (let i = 0; i < menu.itemsCount; i++) {	
			let texDetail = menu.texDetailFunc(i);						
			let offsetY = texDetail.tex.offsetY == 0 ? texDetail.tex.height / 2 : texDetail.tex.offsetY;		
			let slotCenterX = itemsStartX + (i - choosenItemId) * slotWidth + slotWidth / 2;
			let x = Math.floor(slotCenterX - cellW / 2 - texDetail.tex.offsetX);
			let leftOverlap = fromX - x;
			let rightOverlap = x + texDetail.tex.width - toX;
			let y = Math.floor(fromY + menu.height / 2 - cfg.uiBorder - offsetY);
			if ((leftOverlap < 0 || rightOverlap < 0) && leftOverlap < texDetail.tex.width && rightOverlap < texDetail.tex.width) {
				let leftTrim = leftOverlap > 0 ? leftOverlap : 0;
				let rightTrim = rightOverlap > 0 ? rightOverlap : 0;
				let trimWidth = texDetail.tex.width - leftTrim - rightTrim;
				ctx.drawImage(texDetail.tex.canvas, 
					texDetail.col * texDetail.tex.width + leftTrim, texDetail.row * texDetail.tex.height, trimWidth, texDetail.tex.height, 
					x + leftTrim, y, trimWidth, texDetail.tex.height);	
			}
		}
	};
	
	let drawButtons = function() {
		for (let i = 0; i < buttons.length; i++) {
			let button = buttons[i];
			ctx.fillStyle = button.highlighted ? button.highlightBackgroundColor : button.backgroundColor;
			ctx.fillRect(button.x, button.y, button.width, button.height);			
			ctx.fillStyle = button.highlighted ? button.highlightBorderColor : button.borderColor;		
			ctx.fillRect(button.x + cfg.uiBorder, button.y + cfg.uiBorder, button.width - cfg.uiBorder * 2, button.height - cfg.uiBorder * 2);

			ctx.font = button.fontSize + "px Monospace";
			ctx.fillStyle = button.highlighted ? button.highlightFontColor : button.fontColor;
			ctx.fillText(button.text, button.x + cfg.uiSpacing, button.y + button.height - 9);
		}
	};
				
	let drawScene = function(timestamp) {	
		if (!spriteLoader.isLoaded())
			return;
			
		// Update času pro animace
		let delay = timestamp - lastTime;
		lastTime = timestamp;				

		isoRenderer.update(delay, viewX, viewY);
		
		drawButtons();
		
		if (groundsMenu.visible)
			drawItemsMenu(groundsMenu);		
		if (wallsMenu.visible)
			drawItemsMenu(wallsMenu);
		if (objectsMenu.visible)
			drawItemsMenu(objectsMenu);

		$.GIsoGame.Minimap.drawMinimap(ctx, levelReader);
		
		let offsetTolerance = 5;
		if (cursor.mx < levelReader.getMapW() + offsetTolerance && cursor.mx >= -offsetTolerance 
				&& cursor.my < levelReader.getMapH() + offsetTolerance && cursor.my >= -offsetTolerance
				&& desktopArea.mouseDown) {			
			let paintedX = Math.floor(cursor.mx); 
			let paintedY = Math.floor(cursor.my);
			if (paintedX != brush.lastPaintedX || paintedY != brush.lastPaintedY) {
				mapSculptor.paint(paintedX, paintedY, brush);				
				brush.lastPaintedX = paintedX;		
				brush.lastPaintedY = paintedY;
			}
		}		
		
		fpsUI.update(width - cfg.uiMargin, cfg.uiMargin, delay);		
	};		
	
	/*
	* CONTROLS
	*/
	
	let isInBounds = function(uiListener, x, y)  {
		return x > uiListener.x && x < uiListener.x + uiListener.width
			&& y > uiListener.y && y < uiListener.y + uiListener.height;
	};
	
	let mouseButtonChange = function(down, button) {
		for (let i = 0; i < uiListeners.length; i++)
			if (uiListeners[i].visible 
				&& uiListeners[i].onMouse(cursor.sx, cursor.sy, button, down, isInBounds(uiListeners[i], cursor.sx, cursor.sy), uiListeners[i]))
				break;
	};	

	/*
	* MISC
	*/

	let highlightBtns = function(buttons, highlighted) {
		buttons.forEach((b) => {
			b.highlighted = highlighted;
		});
	};

	let displayMapCode = function() {
		document.getElementById("mapcode-text").value = JSON.stringify(levelBlueprint);
		document.getElementById("mapcode-div").style.display = "block";
		document.getElementById("map-width-text").value = levelBlueprint.mapW;
		document.getElementById("map-height-text").value = levelBlueprint.mapH;
	};

	let validate = function(msg, field, min, max) {
		let value = document.getElementById(field).value;
		if (isNaN(value)) {
			alert(msg);
			return false;
		}
		value = Number(value);
		if (value < min || value > max) {
			alert(msg);
			return false;
		}
		return value;
	};

	let saveDraft = function() {
		persistanceManager.saveData(levelBlueprint);		
	};
	
	let updateWindowSize = function() {
		canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
		
		width = canvas.width;
		height = canvas.height;	
		halfWidth = width / 2;
		halfHeight = height / 2;
		
		desktopArea.width = width;
		desktopArea.height = height;
						
		let menus = [groundsMenu, wallsMenu, objectsMenu];
		menus.forEach(function(m) {
			m.x = cfg.uiMargin;
			m.width = width - cfg.uiMargin * 2;
			m.y = height - cfg.uiMargin - groundsMenu.height;	
		});

		if (isoRenderer != undefined) {
			isoRenderer.setWidth(width);
			isoRenderer.setHeight(height);
		}
	};

	/*
	* INIT
	*/	
	
	let createButton = function(text, onClick) {	
		let button = {};
		button.backgroundColor = cfg.uiAreaColor;
		button.borderColor = cfg.uiBorderColor;
		button.fontColor = cfg.uiFontColor;
		button.fontSize = buttonFontSize;

		button.highlightBackgroundColor = "#226";
		button.highlightBorderColor = "#337";
		button.highlightFontColor = "#99c";

		button.highlighted = false;
		button.pushed = false;
		button.visible = true;
		ctx.font = button.fontSize + "px Monospace";		
		button.text = text;
		button.x = cfg.uiMargin;
		if (buttons.length == 0) {
			button.y = cfg.uiMargin + cfg.minimapHeight + cfg.uiMargin;
		} else {
			let lastBtn = buttons[buttons.length - 1];
			button.y = lastBtn.y + lastBtn.height + cfg.uiMargin;
		}
		button.width = ctx.measureText(button.text).width + cfg.uiSpacing * 2;
		button.height = button.fontSize / 2 + cfg.uiSpacing * 2;
		button.onMouse = function(x, y, mouseBtn, down, isInBounds, uiListener) {
			if (isInBounds && mouseBtn == 0) {
				if (down) {
					uiListener.pushed = true;
				} else if (uiListener.pushed) {
					uiListener.pushed = false;
					onClick(button);
				}
				return true;
			}
			return false;
		};
		button.onDrag = function(dx, dy, isInBounds, uiListener) {
			if (isInBounds) 
				document.body.style.cursor = "pointer";
			if (!uiListener.highlighted) {
				uiListener.backgroundColor = isInBounds ? uiListener.highlightBackgroundColor : cfg.uiAreaColor;
				uiListener.borderColor = isInBounds ? uiListener.highlightBorderColor : cfg.uiBorderColor;
				uiListener.fontColor = isInBounds ? uiListener.highlightFontColor : cfg.uiFontColor;
			}
			return false;
		};
		buttons.push(button);
		uiListeners.push(button);
		return button;
	};

	let createButtons = function() {	
		createButton("Menu", function(button) {
			displayMapCode();
		});
		createButton("Povrchy", function(button) {
			groundsMenu.visible = true;
			wallsMenu.visible = false;
			objectsMenu.visible = false;
			highlightBtns(buttons, false);
			button.highlighted = true;
		});
		createButton("Kolizní objekty", function(button) {
			wallsMenu.visible = true;
			groundsMenu.visible = false;
			objectsMenu.visible = false;
			highlightBtns(buttons, false);
			button.highlighted = true;
		});
		createButton("Nekolizní objekty", function(button) {
			objectsMenu.visible = true;
			groundsMenu.visible = false;
			wallsMenu.visible = false;
			highlightBtns(buttons, false);
			button.highlighted = true;
		});
	};

	let createMenu = function() {
		let menu = {
			x: 0,
			y: 0,
			width: 0,
			height: 100,
			visible: true,
			dragged: false,
			itemWidth: cellW * 1.5,
			dragOffset: 0,
			mouseDown: false,
		};		
		menu.onMouse = function(x, y, button, down, isInBounds, uiListener) {
			if (button == 1) {
				if (!down) { 
					uiListener.dragged = false;					
				} else if (isInBounds) {
					uiListener.dragged = true;
					return true;
				}
			} else if (button == 0) {
				if (!down) {
					uiListener.mouseDown = false;
				} else if (isInBounds) {					
					uiListener.mouseDown = true;
					return true;
				}
			}
			return false;
		};
		menu.onDrag = function(dx, dy, isInBounds, uiListener) {
			if (uiListener.dragged) {
				uiListener.dragOffset += dx;
				return true;
			}
			return false;
		};
		uiListeners.push(menu);
		return menu;
	};
	
	let createGroundsMenu = function() {	
		groundsMenu = createMenu();
		let group = 0;
		groundsMenu.texDetailFunc = function(i) {
			return {
				tex: spriteLoader.getTexture(group, i),
				col: 0,
				row: 0
			};
		};
		groundsMenu.chooseItemFunc = function(id) {
			brush.groupId = group;
			brush.spriteId = id;
		};
		groundsMenu.itemsCount = spriteLoader.getGroupSize(group);		
	};
	
	let createSingleSpriteMenu = function(groupId) {
		menu = createMenu();
		let arr = [];
		for (let i = 0; i < spriteLoader.getGroupSize(groupId); i++) {
			let tex = spriteLoader.getTexture(groupId, i);
			let tilesCount = tex.cols * tex.rows;
			for (let j = 0; j < tilesCount; j++)
				arr.push([i, j]);
		}		
		menu.texDetailFunc = function(i) {
			let tex = spriteLoader.getTexture(groupId, arr[i][0]);
			let tileId = arr[i][1];
			return {
				tex: tex,
				col: tileId % tex.cols,
				row: Math.floor(tileId / tex.cols)
			};
		};
		menu.chooseItemFunc = function(i) {
			brush.groupId = groupId;
			brush.spriteId = arr[i][0];
			brush.tileId = arr[i][1];
		};
		menu.itemsCount = arr.length;
		return menu;
	};
	
	let createMenus = function() {
		createGroundsMenu();
		objectsMenu = createSingleSpriteMenu(2);
		objectsMenu.visible = false;
		wallsMenu = createSingleSpriteMenu(3);
		wallsMenu.visible = false;
	};
	
	let createDesktopArea = function() {
		desktopArea = {
			x: 0,
			y: 0,
			width: width,
			height: height,
			visible: true,	
			dragged: false,
			mouseDown: false,
		};
		desktopArea.onMouse = function(x, y, button, down, isInBounds, uiListener) {
			if (button == 1) {
				if (!down) { 
					uiListener.dragged = false;					
				} else if (isInBounds) {
					uiListener.dragged = true;
					return true;
				}
			} else if (button == 0 || button == 2) {
				if (!down) {
					if (uiListener.mouseDown) {
						uiListener.mouseDown = false;
						saveDraft();
					}
				} else if (isInBounds) {
					// aby šlo to samé pole překreslit když na něj kliknu (ne držení)
					brush.lastPaintedX = -1;
					brush.lastPaintedY = -1;	
					brush.mode = button == 0 ? 1 : -1;
					uiListener.mouseDown = true;
					return true;
				}
			}
			return false;			
		};
		desktopArea.onDrag = function(dx, dy, isInBounds, uiListener) {
			if (uiListener.dragged) {
				viewX += dx;
				viewY += dy;
				return true;
			}
			return false;
		};
		uiListeners.push(desktopArea);
	};
	
	let createCanvasListeners = function() {
		canvas.addEventListener('contextmenu', function(e) {		
			if (e.button == 2) e.preventDefault();		
		});
		
		canvas.addEventListener("mousedown", function (e) {
			mouseButtonChange(true, e.button);
		}, false);
	 
		canvas.addEventListener("mouseup", function (e) {
			mouseButtonChange(false, e.button);
		}, false);
		
		canvas.addEventListener("mouseleave", function (e) {
			mouseButtonChange(false, 0);
			mouseButtonChange(false, 1);
			mouseButtonChange(false, 2);
		}, false);
		
		canvas.addEventListener("mousemove", function (e) {
			// výchozí vyresetování kurzoru
			document.body.style.cursor = "default";
		
			let bound = canvas.getBoundingClientRect();
			cursor.lastSx = cursor.sx;
			cursor.lastSy = cursor.sy;
			cursor.sx = e.clientX - bound.x;
			cursor.sy = e.clientY - bound.y;
			let ix = cursor.sx - viewX;
			let iy = cursor.sy - viewY;
			mapCoord = isoRenderer.toMap(ix, iy);	
			cursor.mx = mapCoord.mx;
			cursor.my = mapCoord.my;
			cursor.vix = ix;
			cursor.viy = iy;		
			
			let diffX = cursor.sx - cursor.lastSx;
			let diffY = cursor.sy - cursor.lastSy;
			for (let i = 0; i < uiListeners.length; i++)
				if (uiListeners[i].visible 
					&& uiListeners[i].onDrag(diffX, diffY, isInBounds(uiListeners[i], cursor.sx, cursor.sy), uiListeners[i]))
					break;
		}, false);
	};
	
	let prepareMapTools = function() {
		levelReader = $.GIsoGame.LevelManager.createLevelReader(levelBlueprint);											
		mapSculptor = $.GIsoGame.MapSculptor.create(spritePalette, levelBlueprint);
		isoRenderer = $.GIsoGame.IsoRenderer.create(ctx, width, height, cellW, cellH, levelReader, spriteLoader, cursor);		
		
		let iso = isoRenderer.toIso(levelReader.getMapW() / 2, levelReader.getMapH() / 2);
		viewX = halfWidth - iso.ix;
		viewY = (height - groundsMenu.height - cfg.uiMargin * 2) / 2 - iso.iy;		
	};

	let init = function() {	
		window.addEventListener("resize", updateWindowSize);				
		
		//cfg.outlines = true;					
		
		canvas.style.position = "absolute";
		canvas.style.left = "0";
		canvas.style.top = "0";
		//canvas.style.zIndex = "999";				
		
		spriteLoader = $.GIsoGame.SpriteLoader.create();	
		spritePalette = $.GIsoGame.SpritePalette.create(spriteLoader, cellW, cellH);
						
		createMenus();
		createButtons();		
		createDesktopArea();
		
		updateWindowSize();
		
		fpsUI = $.GIsoGame.FPS.create(100, ctx, 20);
		
		let self = this;
		persistanceManager = $.GIsoGame.PersistanceManager.create();
		persistanceManager.loadData(function(data){
			levelBlueprint = data;
			if (levelBlueprint == undefined) 
				levelBlueprint = $.GIsoGame.LevelManager.createNewLevelBlueprint(10, 10);

			prepareMapTools();			
				
			createCanvasListeners();
				
			// https://developer.mozilla.org/en-US/docs/Web/API/Canvas_API/Tutorial/Optimizing_canvas
			// https://www.html5rocks.com/en/tutorials/canvas/performance/#toc-ref
			// https://developer.mozilla.org/en-US/docs/Web/API/Performance/now
			// https://developer.mozilla.org/en-US/docs/Web/API/Window/requestAnimationFrame
			window.requestAnimationFrame(draw);	
		});				
	};		
		
	let innerCloseMenu = function() {	
		document.getElementById('mapcode-div').style.display = 'none';
	};

	return {	
		start: function() {					
			init();						
		},	
		loadMap: function() {
			levelBlueprint = JSON.parse(document.getElementById("mapcode-text").value);
			prepareMapTools();
			innerCloseMenu();
		},
		newMap: function() {
			let w = validate("Rozměr musí být číslo v rozsahu 10-100", "map-width-text", 10, 100);
			let h = validate("Rozměr musí být číslo v rozsahu 10-100", "map-height-text", 10, 100);
			if (!w || !h)
				return;
			levelBlueprint = $.GIsoGame.LevelManager.createNewLevelBlueprint(w, h);
			prepareMapTools();
			innerCloseMenu();
		},
		closeMenu: function() {
			innerCloseMenu();
		},	
	};
})();

$.GIsoGame.Editor.start();</script>
</body>
</html>