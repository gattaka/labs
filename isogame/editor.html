<!DOCTYPE html>
<html>
<head>
<script type="text/javascript" src="./js/SpriteLoader.js"></script>
<script type="text/javascript" src="./js/LevelManager.js"></script>
<script type="text/javascript" src="./js/GFXUtils.js"></script>
<script type="text/javascript" src="./js/Minimap.js"></script>
<script type="text/javascript" src="./js/IsoRenderer.js"></script>	
<script type="text/javascript" src="./js/Configuration.js"></script>		
<script type="text/javascript" src="./js/MapSculptor.js"></script>			
<script type="text/javascript" src="./js/PersistanceManager.js"></script>	
<script type="text/javascript" src="./js/stats.min.js"></script>		
<script type="text/javascript" src="./js/SpritePalette.js"></script>			
<script type="text/javascript" src="./js/EditorControls.js"></script>
<script type="text/javascript" src="./js/SpriteMenu.js"></script>
<style>
	#mapcode-div {
		display: none;
		position: absolute;
		z-index: 300;
		width: 100%;
		height: 100%;
		background-color: hsla(0, 0%, 0%, 0.61);
		padding: 10px;
		margin: 0;
		top: 0;
		left: 0;
		box-sizing: border-box;
		text-align: center;		
	}

	#mapcode-text {
		width: 80%;
		height: 50%;
	}

</style>
</head>
<body>
<div id="mapcode-div">
	<textarea id="mapcode-text"></textarea><br/>
	<br/>
	<a class="ui-button" onClick="$.GIsoGame.Editor.loadMap()">Nahrát mapu dle JSON</a><br/>
	<br/>
	<br/>
	<input id="map-width-text" /> x <input id="map-height-text" /><br/>
	<br/>
	<a class="ui-button" onClick="$.GIsoGame.Editor.newMap()">Nová mapa</a><br/>
	<br/>
	<br/>
	<a class="ui-button" onClick="$.GIsoGame.Editor.closeMenu()">Zavřít</a>
</div>
<div style="margin: 10px 0;">
	<canvas id="groundCanvas" style="width: 100%;" height="600"></canvas>
	<canvas id="objectsCanvas" style="width: 100%;" height="600"></canvas>
	<canvas id="uiCanvas" style="width: 100%;" height="600"></canvas>
</div>
<script>
var $ = $ || {};
$.GIsoGame = $.GIsoGame || {};
$.GIsoGame.Editor = (function() {

	let groundCanvas = document.getElementById("groundCanvas");
	let groundCtx = groundCanvas.getContext("2d", { alpha: false });
	let objectsCanvas = document.getElementById("objectsCanvas");
	let objectsCtx = objectsCanvas.getContext("2d");
	let uiCanvas = document.getElementById("uiCanvas");
	let uiCtx = uiCanvas.getContext("2d");
	let width;
	let height;
	let halfWidth;
	let halfHeight;
	
	let levelDraftCookieName = "GIsoGameLevelDraft";
	
	let cfg = $.GIsoGame.Configuration;
	
	let stats;
	let persistanceManager;
	
	let spriteLoader;
	let spritePalette;
	
	let levelReader;
	let levelBlueprint;
	let isoRenderer;
	let mapSculptor;
	
	let controls;
	
	let lastTime = 0;
	
	let viewX = 0;
	let viewY = 0;	
	
	let desktopArea = {};			
	let groundsMenu = {};
	let wallsMenu = {};
	let objectsMenu = {};
	
	let buttons = [];
	
	// Ground tiles vyplňování
	let brush = {
		size: 1,
		mode: 1, // 1 malba, -1 mazání
		type: 0, // 0 grounds, 2 objects, 3 walls, 4 lights
		spriteId: 0,
		tileId: 0,
		light: 70,
		lightReach: 10,
		lastPaintedX: -1,
		lastPaintedY: -1,
	};		
	
	let cursor = {
		mx: 0, 
		my: 0,
		vix: 0,
		viy: 0,		
	};		

	/*
	* DRAWING
	*/	
	
	let draw = function(timestamp) {
		stats.begin();
		drawScene(timestamp);
		stats.end();
		window.requestAnimationFrame(draw);
	};	
				
	let drawScene = function(timestamp) {	
		if (!spriteLoader.isLoaded())
			return;
			
		// Update času pro animace
		let delay = timestamp - lastTime;
		lastTime = timestamp;				

		isoRenderer.update(delay, viewX, viewY);
		
		uiCtx.clearRect(0, 0, width, height);
		
		if (groundsMenu.visible)
			$.GIsoGame.SpriteMenu.draw(uiCtx, groundsMenu);
		if (wallsMenu.visible)
			$.GIsoGame.SpriteMenu.draw(uiCtx, wallsMenu);
		if (objectsMenu.visible)
			$.GIsoGame.SpriteMenu.draw(uiCtx, objectsMenu);

		$.GIsoGame.Minimap.drawMinimap(uiCtx, levelReader);
		
		let offsetTolerance = 5;
		if (cursor.mx < levelReader.getMapW() + offsetTolerance && cursor.mx >= -offsetTolerance 
				&& cursor.my < levelReader.getMapH() + offsetTolerance && cursor.my >= -offsetTolerance
				&& desktopArea.mouseDown) {			
			let paintedX = Math.floor(cursor.mx); 
			let paintedY = Math.floor(cursor.my);
			if (paintedX != brush.lastPaintedX || paintedY != brush.lastPaintedY) {
				mapSculptor.paint(paintedX, paintedY, brush);				
				brush.lastPaintedX = paintedX;		
				brush.lastPaintedY = paintedY;
			}
		}					
	};			

	let displayMapCode = function() {
		document.getElementById("mapcode-text").value = JSON.stringify(levelBlueprint);
		document.getElementById("mapcode-div").style.display = "block";
		document.getElementById("map-width-text").value = levelBlueprint.mapW;
		document.getElementById("map-height-text").value = levelBlueprint.mapH;
	};

	let validate = function(msg, field, min, max) {
		let value = document.getElementById(field).value;
		if (isNaN(value)) {
			alert(msg);
			return false;
		}
		value = Number(value);
		if (value < min || value > max) {
			alert(msg);
			return false;
		}
		return value;
	};

	let saveDraft = function() {
		persistanceManager.saveData(levelBlueprint);		
	};
	
	let updateWindowSize = function() {
		width = window.innerWidth;
		height = window.innerHeight;	
		halfWidth = width / 2;
		halfHeight = height / 2;
		for (c of [groundCanvas, objectsCanvas, uiCanvas]) {
			c.width = width;
			c.height = height;
		}
		
		desktopArea.width = width;
		desktopArea.height = height;
						
		let menus = [groundsMenu, wallsMenu, objectsMenu];
		menus.forEach(function(m) {
			m.x = cfg.uiMargin;
			m.width = width - cfg.uiMargin * 2;
			m.y = height - cfg.uiMargin - groundsMenu.height;	
		});

		if (isoRenderer != undefined) {
			isoRenderer.setWidth(width);
			isoRenderer.setHeight(height);
		}
	};
	
	let createButton = function(text, x, y, onClick) {
		let button = document.createElement("a");
		button.classList.add("ui-button");
		button.style.cssText = "position: fixed; top: " + y + "px; left: " + x + "px; z-index: 200;";
		button.innerHTML = text;	
		button.addEventListener("click", function(a){ a.preventDefault(); onClick(button); });
		document.body.appendChild(button);
		buttons.push(button);
	};
		
	let switchMenuButton = function(button, menu) {		
		buttons.forEach(b => b.classList.remove("ui-button-selected"));
		button.classList.add("ui-button-selected")
		groundsMenu.visible = false;
		wallsMenu.visible = false;
		objectsMenu.visible = false;
		if (menu != undefined)
			menu.visible = true;
		isoRenderer.setLights(false);
	};

	let createButtons = function() {	
		let x = cfg.uiMargin;
		let y = cfg.uiMargin + cfg.minimapHeight + cfg.uiMargin;
		let dy = cfg.uiButtonHeight + cfg.uiPadding * 2 + cfg.uiMargin;
		let i = 0;
		createButton("Menu", x, y + i++ * dy, button => displayMapCode());
		createButton("Povrchy", x, y + i++ * dy, button => switchMenuButton(button, groundsMenu));
		createButton("Kolizní objekty", x, y + i++ * dy, button => switchMenuButton(button, wallsMenu));			
		createButton("Nekolizní objekty", x, y + i++ * dy, button => switchMenuButton(button, objectsMenu));
		createButton("Světla", x, y + i++ * dy, button => {
			switchMenuButton(button); 
			isoRenderer.setLights(true);
			brush.type = 4;
		});
	};
	
	let createGroundsMenu = function() {	
		groundsMenu = $.GIsoGame.SpriteMenu.create(spritePalette.getCellW());
		let group = 0;
		groundsMenu.texDetailFunc = function(i) { return { tex: spriteLoader.getTexture(group, i), col: 0, row: 0 } };
		groundsMenu.chooseItemFunc = function(id) {
			brush.type = 0;
			brush.spriteId = id;
		};
		groundsMenu.itemsCount = spriteLoader.getGroupSize(group);
		controls.addUIListener(groundsMenu);		
	};
	
	let createSingleSpriteMenu = function(type, groupId) {
		menu = $.GIsoGame.SpriteMenu.create(spritePalette.getCellW());
		let arr = [];
		for (let i = 0; i < spriteLoader.getGroupSize(groupId); i++) {
			let tex = spriteLoader.getTexture(groupId, i);
			let tilesCount = tex.cols * tex.rows;
			for (let j = 0; j < tilesCount; j++)
				arr.push([i, j]);
		}		
		menu.texDetailFunc = function(i) {
			let tex = spriteLoader.getTexture(groupId, arr[i][0]);
			let tileId = arr[i][1];
			return { tex: tex, col: tileId % tex.cols, row: Math.floor(tileId / tex.cols) };
		};
		menu.chooseItemFunc = function(i) {
			brush.type = type;
			brush.spriteId = arr[i][0];
			brush.tileId = arr[i][1];
		};
		menu.itemsCount = arr.length;
		controls.addUIListener(menu);		
		return menu;
	};
	
	let createMenus = function() {
		createGroundsMenu();
		wallsMenu = createSingleSpriteMenu(3, 3);
		objectsMenu = createSingleSpriteMenu(2, 2);		
	};
	
	let createDesktopArea = function() {
		desktopArea = { x: 0, y: 0, width: width, height: height, visible: true, dragged: false, mouseDown: false };
		desktopArea.onMouse = function(movement, button, down, isInBounds, uiListener) {
			if (button == 1) {
				if (!down) { 
					uiListener.dragged = false;					
				} else if (isInBounds) {
					uiListener.dragged = true;
					return true;
				}
			} else if (button == 0 || button == 2) {
				if (!down) {
					if (uiListener.mouseDown) {
						uiListener.mouseDown = false;
						saveDraft();
					}
				} else if (isInBounds) {
					// aby šlo to samé pole překreslit když na něj kliknu (ne držení)
					brush.lastPaintedX = -1;
					brush.lastPaintedY = -1;	
					brush.mode = button == 0 ? 1 : -1;
					uiListener.mouseDown = true;
					return true;
				}
			}
			return false;			
		};
		desktopArea.onDrag = function(movement, isInBounds, uiListener) {						
			// ukazatel pole na mapě
			let ix = movement.x - viewX;
			let iy = movement.y - viewY;
			mapCoord = isoRenderer.toMap(ix, iy);	
			cursor.mx = mapCoord.mx;
			cursor.my = mapCoord.my;
			cursor.vix = ix;
			cursor.viy = iy;	
			
			// posuv mapy přes MMB
			if (uiListener.dragged) {
				viewX += movement.dx;
				viewY += movement.dy;
				return true;
			}
			return false;
		};
		controls.addUIListener(desktopArea);
	};
	
	let onCellRenderFunc = function(mx, my, ix, iy) {
		if (!isoRenderer.isLights())
			return;
		levelBlueprint.lights.forEach(light => {			
			if (light != undefined && Math.floor(light.mx) == mx && Math.floor(light.my) == my) {
				objectsCtx.fillStyle = "black";				
				let x = ix + spritePalette.getCellW() / 4;
				objectsCtx.fillRect(x, iy - 40, spritePalette.getCellW() / 2 + 5, 30); 
				objectsCtx.font = "15px Monospace";
				objectsCtx.fillStyle = "yellow";
				objectsCtx.fillText(light.light + "%", x, iy - 30);
				objectsCtx.fillText(light.lightReach + "%", x, iy - 15);
				$.GIsoGame.GFXUtils.drawPoint(objectsCtx, Math.floor(ix + spritePalette.getCellW() / 2), Math.floor(iy), "yellow", 4);
			}
		});		
	};
	
	let prepareMapTools = function() {
		levelReader = $.GIsoGame.LevelManager.createLevelReader(levelBlueprint);											
		mapSculptor = $.GIsoGame.MapSculptor.create(spritePalette, levelBlueprint);
		isoRenderer = $.GIsoGame.IsoRenderer.create(groundCtx, objectsCtx, width, height, spritePalette.getCellW(), spritePalette.getCellH(), 
													levelReader, spriteLoader, cursor, onCellRenderFunc);		
		
		let iso = isoRenderer.toIso(levelReader.getMapW() / 2, levelReader.getMapH() / 2);
		viewX = halfWidth - iso.ix;
		viewY = (height - groundsMenu.height - cfg.uiMargin * 2) / 2 - iso.iy;		
	};

	let init = function() {	
		window.addEventListener("resize", updateWindowSize);				
		
		for (c of [groundCanvas, objectsCanvas, uiCanvas]) {
			c.style.position = "absolute";
			c.style.left = "0";
			c.style.top = "0";
		}
		groundCanvas.style.zIndex = "100";
		objectsCanvas.style.zIndex = "101";
		uiCanvas.style.zIndex = "102";
		
		let subCanvasSmoothing = false;
		for (c of [groundCtx, objectsCtx, uiCtx]) {
			c.webkitImageSmoothingEnabled = subCanvasSmoothing;
			c.mozImageSmoothingEnabled = subCanvasSmoothing;
			c.imageSmoothingEnabled = subCanvasSmoothing;
			c.msImageSmoothingEnabled = subCanvasSmoothing;
		}
		
		let sheet = window.document.styleSheets[0];
		sheet.insertRule(".ui-button {"
							+ "cursor: pointer;"
							+ "font-size: " + cfg.uiButtonFontSize + "px;"
							+ "font-family: monospace;"
							+ "font-weight: normal;"
							+ "color: " + cfg.uiFontColor + ";"
							+ "background: " + cfg.uiAreaColor + ";" 
							+ "border: " + cfg.uiBorder + "px solid " + cfg.uiBorderColor + ";"
							+ "padding: " + (cfg.uiPadding - 3) + "px " + cfg.uiPadding + "px;"
						+ "}", sheet.cssRules.length);
		sheet.insertRule(".ui-button:hover, .ui-button-selected {"							
							+ "color: " + cfg.uiHoverFontColor + ";"
							+ "background: " + cfg.uiHoverAreaColor + ";" 
							+ "border-color: " + cfg.uiHoverBorderColor + ";"
						+ "}", sheet.cssRules.length);
		
		stats = new Stats();
		stats.showPanel(0); // 0: fps, 1: ms, 2: mb, 3+: custom
		document.body.appendChild(stats.dom);
		
		spriteLoader = $.GIsoGame.SpriteLoader.create();	
		spritePalette = $.GIsoGame.SpritePalette.create(spriteLoader);

		controls = $.GIsoGame.EditorControls.create(uiCanvas);
		
		let self = this;
		persistanceManager = $.GIsoGame.PersistanceManager.create();
		persistanceManager.loadData(data => {
			levelBlueprint = data;
			if (levelBlueprint == undefined) 
				levelBlueprint = $.GIsoGame.LevelManager.createNewLevelBlueprint(10, 10);
			
			createMenus();
			createButtons();		
			createDesktopArea();	
			
			updateWindowSize();	
			prepareMapTools();						
			
			//switchMenuButton(buttons[2], wallsMenu);
				
			// https://developer.mozilla.org/en-US/docs/Web/API/Canvas_API/Tutorial/Optimizing_canvas
			// https://www.html5rocks.com/en/tutorials/canvas/performance/#toc-ref
			// https://developer.mozilla.org/en-US/docs/Web/API/Performance/now
			// https://developer.mozilla.org/en-US/docs/Web/API/Window/requestAnimationFrame
			window.requestAnimationFrame(draw);	
		});				
	};		
		
	let innerCloseMenu = function() {	
		document.getElementById('mapcode-div').style.display = 'none';
	};

	return {	
		start: function() {					
			init();						
		},	
		loadMap: function() {
			levelBlueprint = JSON.parse(document.getElementById("mapcode-text").value);
			prepareMapTools();
			innerCloseMenu();
		},
		newMap: function() {
			let w = validate("Rozměr musí být číslo v rozsahu 10-100", "map-width-text", 10, 100);
			let h = validate("Rozměr musí být číslo v rozsahu 10-100", "map-height-text", 10, 100);
			if (!w || !h)
				return;
			levelBlueprint = $.GIsoGame.LevelManager.createNewLevelBlueprint(w, h);
			prepareMapTools();
			innerCloseMenu();
		},
		closeMenu: function() {
			innerCloseMenu();
		},	
		light: function(value) {
			if (value < 0) {
				ctx.globalCompositeOperation = "multiply";
				ctx.fillStyle = "black";
				ctx.globalAlpha = -value / 100;
				ctx.fillRect(0, 0, canvas.width, canvas.height);
			} else if (value > 0) {
				ctx.fillStyle = "white";
				ctx.globalCompositeOperation = "lighten";
				ctx.globalAlpha = 1;
				ctx.drawImage(image, 0, 0);
				ctx.globalAlpha = value / 100;
				ctx.fillRect(0, 0, canvas.width, canvas.height);
			}
		}
	};
})();

$.GIsoGame.Editor.start();</script>
</body>
</html>