[HTML]<head>
	<script type="text/javascript" src="./SpriteLoader.js"></script>
	<script type="text/javascript" src="./LevelLoader.js"></script>
	<script type="text/javascript" src="./GFXUtils.js"></script>
	<script type="text/javascript" src="./Minimap.js"></script>
	<script type="text/javascript" src="./IsoRenderer.js"></script>	
	<script type="text/javascript" src="./Configuration.js"></script>		
</head>
<div style="margin: 10px 0;">
	<canvas id="canvasT" style="width: 100%;" height="600"></canvas>
</div>[/HTML]
<script>
var $ = $ || {};
$.GIsoGame = $.GIsoGame || {};
$.GIsoGame.Editor = (function() {

	let canvas = document.getElementById("canvasT");
	let ctx = canvas.getContext("2d");
	let width;
	let height;
	let halfWidth;
	let halfHeight;
	
	let spriteLoader;
	let levelLoader;
	let currentLevel;
	let isoRenderer;
	
	let lastTime = 0;
	
	let viewX = 0;
	let viewY = 0;
	
	let cellW = 64;
	let cellH = 32;	
	
	let menuMargin = 10;
	let menuBorder = 2;
	let texMenuHeight = 100;
	let texMenuOffset = 0;
	let texMenuBorder = 20;
	
	let choosenTextureGroup = 0;
	let choosenTextureSprite = 0;
	let choosenTextureFrame = 0;
	
	let level;
	
	// T/F dle tlačítka myši
	let mouseButtons = [];
	let mouseDownX = 0;
	let mouseDownY = 0;
		
	let cursor = {
		sx: 0,
		sy: 0,
		mx: 0, 
		my: 0,
		vix: 0,
		viy: 0,		
	};		

	/*
	* DRAWING
	*/	
	
	let draw = function(timestamp) {
		drawScene(timestamp);
		window.requestAnimationFrame(draw);
	};
	
	let drawTilesMenu = function() {
		let texMenuFromX = menuMargin;
		let texMenuToX = width - menuMargin;
		let texMenuFromY = height - menuMargin - texMenuHeight;
		let texMenuToY = height - menuMargin;
		
		ctx.fillStyle = "#333";		
		ctx.fillRect(texMenuFromX, texMenuFromY, texMenuToX - texMenuFromX, texMenuToY - texMenuFromY);
		
		// zmenšení aktivní plochy menu, aby se v ní dalo pracovat s položkami
		texMenuFromX += menuBorder;
		texMenuToX -= menuBorder;
		texMenuFromY += menuBorder;
		texMenuToY -= menuBorder;
		let texMenuHalfHeight = texMenuHeight / 2 - menuBorder;
		
		ctx.fillStyle = "#222";		
		ctx.fillRect(texMenuFromX, texMenuFromY, texMenuToX - texMenuFromX, texMenuToY - texMenuFromY);
		
		let tex = spriteLoader.getTexture(0, 0);		
		ctx.fillStyle = "#333";		
		ctx.fillRect(width / 2 - tex.width / 2 - texMenuBorder / 2, texMenuFromY, tex.width + texMenuBorder, texMenuToY - texMenuFromY);
		
		for (let i = 0; i < tex.cols * tex.rows; i++) {			
			let col = i % tex.cols;
			let row = Math.floor(i / tex.cols);
			let x = Math.floor(width / 2 - tex.width / 2) + (i + texMenuOffset) * (tex.width + texMenuBorder);
			let y = Math.floor(texMenuFromY + texMenuHalfHeight - tex.height / 2);
			let leftOverlap = texMenuFromX - x;
			let rightOverlap = x + tex.width - texMenuToX;
			if ((leftOverlap < 0 || rightOverlap < 0) && leftOverlap < tex.width && rightOverlap < tex.width) {
				let leftTrim = leftOverlap > 0 ? leftOverlap : 0;
				let rightTrim = rightOverlap > 0 ? rightOverlap : 0;
				let trimWidth = tex.width - leftTrim - rightTrim;
				ctx.drawImage(tex.canvas, 
					col * tex.width + leftTrim, row * tex.height, trimWidth, tex.height, 
					x, y, trimWidth, tex.height);	
			}
		}
	};
			
	let drawScene = function(timestamp) {	
		if (!spriteLoader.isLoaded())
			return;
			
		// Update času pro animace
		let delay = timestamp - lastTime;
		lastTime = timestamp;	
				
		isoRenderer.update(delay, viewX, viewY);
		
		drawTilesMenu();		

		$.GIsoGame.Minimap.drawMinimap(ctx, currentLevel);
		
		if (cursor.mx < level.mapW && cursor.mx >= 0 && cursor.my < level.mapH && cursor.my >= 0) {
			if (mouseButtons[0] || mouseButtons[2]) {
				let val = mouseButtons[0] ? [choosenTextureSprite, choosenTextureFrame] : undefined;
				level.grounds[Math.floor(cursor.mx) + Math.floor(cursor.my) * level.mapW] = val;
			}
		}		
	};		

	/*
	* INIT
	*/	
	
	let init = function() {	
		canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
		
		$.GIsoGame.Configuration.outlines = true;
			
		width = canvas.width;
		height = canvas.height;	
		halfWidth = width / 2;
		halfHeight = height / 2;
		
		canvas.style.position = "absolute";
		canvas.style.left = "0";
		canvas.style.top = "0";
		canvas.style.zIndex = "999";		
				
		level = {
			mapW: 10,
			mapH: 10,
			grounds:[],
			objects: [],
			walls: []
		}
	
		currentLevel = $.GIsoGame.LevelLoader.createLevel(level);
		
		spriteLoader = $.GIsoGame.SpriteLoader.create();
		spriteLoader.queueTexture(0, "https://www.gattserver.cz/fm-files/isometric-files/ground/grass_medium_64x32.png", 8, 7, cellW, cellH, 0, 0);
		spriteLoader.queueTexture(0, "https://www.gattserver.cz/fm-files/isometric-files/ground/stone_path_64x32.png", 8, 7, cellW, cellH, 0, 0);			
		spriteLoader.queueTexture(0, "https://www.gattserver.cz/fm-files/isometric-files/ground/grass_dry_64x32.png", 8, 7, cellW, cellH, 0, 0);		
		spriteLoader.queueTexture(2, "https://www.gattserver.cz/fm-files/isometric-files/plants/weed03.png", 1, 1, 128, 64, 0, 16);
		spriteLoader.queueTexture(2, "https://www.gattserver.cz/fm-files/isometric-files/plants/swirl02.png", 1, 1, 128, 64, 0, 16);
		spriteLoader.queueTexture(3, "https://www.gattserver.cz/fm-files/isometric-files/walls/iso_dungeon_walls_by_pfunked.png", 8, 4, 128, 128, 32, 64 + 16);
		spriteLoader.queueTexture(3, "https://www.gattserver.cz/fm-files/isometric-files/plants/pine-none03.png", 1, 1, 256, 256, 64 + 42, 128 + 64);
		spriteLoader.queueTexture(3, "https://www.gattserver.cz/fm-files/isometric-files/walls/barricade_tiles.png", 4, 3, 128, 128, 32, 64 + 16);
		
		spriteLoader.load();
			
		isoRenderer = $.GIsoGame.IsoRenderer.create(ctx, width, height, cellW, cellH, currentLevel, spriteLoader, cursor);		
		
		viewX = halfWidth;
		viewY = halfHeight;
								
		// https://developer.mozilla.org/en-US/docs/Web/API/Canvas_API/Tutorial/Optimizing_canvas
		// https://www.html5rocks.com/en/tutorials/canvas/performance/#toc-ref
		// https://developer.mozilla.org/en-US/docs/Web/API/Performance/now
		// https://developer.mozilla.org/en-US/docs/Web/API/Window/requestAnimationFrame
		window.requestAnimationFrame(draw);		
	};		
	
	let mouseButtonChange = function(down, e) {
		mouseButtons[e.button] = down;				
	};
	
	canvas.addEventListener('contextmenu', function(e) {
		if (e.button == 2) {
		  // Block right-click menu thru preventing default action.
		  e.preventDefault();
		}
	 });
	
	canvas.addEventListener("mousedown", function (e) {
		mouseButtonChange(true, e);
		mouseDownX = cursor.sx;
		mouseDownY = cursor.sy;
	}, false);
 
	canvas.addEventListener("mouseup", function (e) {
		mouseButtonChange(false, e);
	}, false);
	
	canvas.addEventListener("mouseleave", function (e) {
		mouseButtonChange(false, e);
	}, false);
	
	canvas.addEventListener("mousemove", function (e) {
		let bound = canvas.getBoundingClientRect();
		cursor.sx = e.clientX - bound.x;
		cursor.sy = e.clientY - bound.y;
		let ix = cursor.sx - viewX;
		let iy = cursor.sy - viewY;
		mapCoord = isoRenderer.toMap(ix, iy);	
		cursor.mx = mapCoord.mx;
		cursor.my = mapCoord.my;
		cursor.vix = ix;
		cursor.viy = iy;
		if (mouseButtons[1]) {
			viewX += cursor.sx - mouseDownX;
			viewY += cursor.sy - mouseDownY;
			mouseDownX = cursor.sx;
			mouseDownY = cursor.sy;
		}
	}, false);
		
	return {	
		start: function() {					
			init();						
		},	
	};

})();

$.GIsoGame.Editor.start();</script>